// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('3E([\'7\',\'2O\',\'2G/3F/1U\'],d(7,2O,1U){9 3={4:{1H:0,v:[],2q:[],1f:[],K:0,29:0,2g:0,33:0,V:0,B:0,s:0,A:0,M:0,L:"",1m:0,1h:\'\',2j:0}};3.3G=d(4){3.4=$.3D(3.4,4||{});3.4.s=0;$(\'#k\').i(\'.q-w-1b\').5(\'优惠券\');$(\'#k\').i(\'.q-w-1d\').5(\'\');9 m=7.g($(".m").f());9 n=7.g($(".n").f());6(m>0){$(\'.14\').c()}6(n>0){$(\'.17\').c()}9 D=19;6(1P(O.1L)!==\'1M\'){D=O.1L}j 6(1P(O.2P)!==\'1M\'){D=O.2P;D.z=D.3y.3z(/ /3A,\'\')+\' \'+D.z}6(D){3.4.V=D.T;$(\'#N .2J-z\').c();$(\'#N .2M-z\').h();$(\'#N .3B-3H\').c();$(\'#N .1c\').5(D.1c);$(\'#N .1R\').5(D.1R);$(\'#N .z\').5(D.z);$(\'#N a\').P(\'1I\',7.1E(\'37/z/3I\'));$(\'#N a\').J(d(){O.3P=D.T})}9 11=19;6(1P(O.2N)!==\'1M\'){11=O.2N;3.4.2e=11.T;$(\'#y .1Q\').5(11.1Q);$(\'#y .1c\').5(11.1c);$(\'#31\').5(11.1R);$(\'#y .z\').5(11.z);$(\'#y\').i(\'.2M-z\').1q("1n","3x");$(\'#y\').i(\'.2J-z\').1q("1n","1G");$(\'#y\').i(\'.q-3J-3K\').1q("1n","1G");$(\'#y\').i(\'.1p\').1q("1n","1G");$(\'#y\').i(\'.3L\').1q("1n","1G")}u.3k({1V:$(\'#3m\'),3o:{3n:d(){3.4.K=0;$(\'#N\').c(),$(\'#y\').h(),$(\'#2Q\').h(),$(\'#2R\').c();3.1e()},3l:d(){3.4.K=1;$(\'#N\').h(),$(\'#y\').c(),$(\'#2Q\').c(),$(\'#2R\').h();3.1e()}}});9 S=$(\'.q-S\');6(S.r>0){9 2f=S.e(\'2f\')||0,1j=S.e(\'1j\'),2d=S.e(\'2d\')||0,1F=S.e(\'1F\')||\'件\';S.3q({2Y:2f,2X:2d,3t:"{2X}"+1F+"起售",3s:"最多购买{2Y}"+1F,3w:d(1r){$.Z(3.4.v,d(){6(l.1j==1j){l.1T=1r;p 19}});$.Z(3.4.2q,d(){6(l.1j==1j){l.1T=1r;p 19}});3.4.B=0;3.4.s=0;3.4.A=0;3.4.M="";3.4.L="";3.4.1w=0;$(\'#k\').i(\'.q-w-1b\').5(\'优惠券\');$(\'#k\').i(\'.q-w-1d\').5(\'\');$(\'#3N\').5(1r);9 1C=7.g(S.30(\'.v-2a\').i(\'.1C\').5())*1r;$(\'.G\').5(7.o(1C,2));3.1e()}})}$(\'#H\').J(d(){3.Y()});$(\'#x\').J(d(){3.Y()});3.2s();$(4m).J(d(){$(\'Q,2V,2I\').Z(d(){$(l).P(\'e-10\',$(l).f())});$(\':2T,:2U\').Z(d(){$(l).P(\'e-U\',$(l).1a(\'U\'))})});$(\'Q,2V,2I\').Z(d(){9 10=$(l).P(\'e-10\')||\'\';6(10!=\'\'){$(l).f(10)}});$(\':2T,:2U\').Z(d(){9 10=$(l).P(\'e-U\')===\'I\'?I:19;$(l).1a(\'U\',10)});$(\'.4k\').J(d(){3.1A(l,4.1z)});3.1e();$(".q-w-4g").J(d(){3.12=2u 2v({2w:$(\'#2b-13-3\').5(),2H:\'13-3\',2y:d(){3.12.2c()}});3.12.1V.i(\'.2E-4h\').J(d(){3.12.2c()});3.12.c();9 W=$("#W").f();$(".2b-2a").Z(d(){6($(l).f()==W){$(l).1a("U","I")}});$(".2b-2a").4w("J",d(){$.4x({4y:7.1E(\'v/4v/4u\',{T:$(l).f()}),4r:I,4s:d(e){e=O.4t.4p(e);6(e.1o>0){$("#W").f(e.8.T);$("#4e").1p(e.8.4f)}}})})});$(\'.c-41-2E\').J(d(){$(l).30(\'.3Z-1V\').3Y(\'3U\')})};3.12=d(){3.12=2u 2v({2w:$(\'#43-13-3\').5(),2H:\'13-3\',2y:d(){3.4b.2c()}})};3.2s=d(){$(\'#k\').4c(\'J\').J(d(){$(\'#2F\').c();7.1B(\'2D/2C/4d/4a\',{2t:0,49:0,1f:3.4.1f,v:3.4.v},d(16){$(\'#2F\').h();6(16.8.1J.r>0||16.8.1N.r>0){$(\'#k\').c().i(\'.1O\').5(16.8.1J.r+16.8.1N.r).c();$(\'#k\').i(\'.1p\').h();46([\'2G/2D/2C/13\'],d(13){13.c({s:3.4.s,1J:16.8.1J,1N:16.8.1N,4n:d(){3.4.B=0;3.4.s=0;3.4.A=0;3.4.M="";3.4.L="";3.4.1w=0;$(\'#k\').i(\'.q-w-1b\').5(\'优惠券\');$(\'#k\').i(\'.q-w-1d\').5(\'\');3.Y()},48:d(e){3.4.B=e.B;6(3.4.B==1){3.4.s=0;3.4.A=e.A;3.4.M=e.M;3.4.L=e.L;3.4.1w=e.3f;$(\'#k\').i(\'.q-w-1b\').5(\'已选择\');$(\'#k\').i(\'.q-w-1d\').5(e.3e);$(\'#k\').e(e);3.Y()}j 6(3.4.B==2){3.4.s=e.s;3.4.A=0;3.4.M="";3.4.L="";3.4.1w=e.3f;$(\'#k\').i(\'.q-w-1b\').5(\'已选择\');$(\'#k\').i(\'.q-w-1d\').5(e.3e);$(\'#k\').e(e);3.Y()}j{3.4.B=0;3.4.s=0;3.4.A=0;3.4.M="";3.4.L="";3.4.1w=0;$(\'#k\').i(\'.q-w-1b\').5(\'优惠券\');$(\'#k\').i(\'.q-w-1d\').5(\'\');3.Y()}}})})}j{u.R.c(\'未找到优惠券!\');3.3h()}},19,I)})};3.3h=d(){$(\'#k\').h();$(\'#k\').i(\'.1O\').5(\'0\').h();$(\'#k\').i(\'.1p\').c()};3.1e=d(){9 G=7.g($(\'.G\').5());9 F=7.g($(".F").f());9 E=7.g($(".E").f());9 m=7.g($(".m").f());9 n=7.g($(".n").f());9 t=G-F-E-m-n;6($(\'.1X\').r>0){t=7.g($(\'.1C\').5())*1S($(\'.1X\').f())}6(3.4.1Y==0){6(3.4.v.r==1){3.4.v[0].1T=1S($(\'.1X\').f())}}6(1P(O.1L)!==\'1M\'){3.4.V=O.1L.T}7.1B(\'1D/2m/1e\',{t:t,V:3.4.V,35:3.4.35,3X:3.4.K,v:3.4.v,20:3.4.20},d(b){6(b.1o==1){6(3.4.K){$(\'.1t\').5(\'0.1u\')}j{$(\'.1t\').5(7.o(b.8.3W,2))}6(b.8.F){$(\'#F\').f(7.o(b.8.F,2))}6(b.8.E){$(\'#E\').f(7.o(b.8.E,2))}6(b.8.m){$(\'#m\').f(7.o(b.8.m,2))}6(b.8.1l){$(\'#1l\').f(7.o(b.8.1l,2));$(\'#3V\').5(7.o(b.8.1l,2)).42(".q-w").c()}6(b.8.n){$(\'#n\').f(7.o(b.8.n,2))}6(b.8.H){$(\'#4l\').5(7.o(b.8.3a,2));$(\'#4o\').5(b.8.H);$("#H").e(\'3T\',b.8.H);$("#H").e(\'2t\',7.o(b.8.3a,2))}6(b.8.x){$(\'#1x\').5(b.8.x);$("#x").e(\'2o\',b.8.x)}6(b.8.22>0){$(\'#22\').c()}j{$(\'#22\').h()}6(b.8.1K>0){$(\'#1K\').c();$(\'#3g\').5(7.o(b.8.1K,2))}j{$(\'#1K\').h();$(\'#3g\').5(0)}6(b.8.34>0){$(\'#k\').c().i(\'.1O\').5(b.8.34).c();$(\'#k\').i(\'.1p\').h()}j{3.4.s=0;$(\'#k\').h().i(\'.1O\').5(0).h()}6(b.8.18>0){$(\'#36\').c();$(\'#18\').5(7.o(b.8.18,2));$(\'#24\').5(7.o(b.8.24,2))}j{$(\'#36\').h();$(\'#18\').5(\'0.1u\');$(\'#24\').5(\'0.1u\')}6(b.8.15>0){$(\'#38\').c();$(\'#15\').5(7.o(b.8.15,2));$(\'#27\').5(7.o(b.8.27,2))}j{$(\'#38\').h();$(\'#15\').5(\'0.1u\');$(\'#27\').5(\'0.1u\')}6(b.8.1f){3.4.1f=b.8.1f}6(b.8.1m==1){3.1m=1;3.1h=b.8.1h;u.R.c(3.1h)}j{3.1m=0;3.1h=\'\'}3.Y()}},I,I)};3.2i=d(1y){9 G=7.g($(\'.G\').5());9 1y=1y;9 F=7.g($(".3c").5());9 E=7.g($(".2A").5());9 m=7.g($(".1s").5());9 n=7.g($(".1v").5());9 39=7.g($("#1l").f());9 t=G-F-E-m-n-1y-39;9 1t=7.g($(".1t").5());9 26=0;6($("#18").r>0&&$("#18").5()!=\'\'){26=7.g($("#18").5())}9 25=0;6($("#15").r>0&&$("#15").5()!=\'\'){25=7.g($("#15").5())}t=t-26-25+1t;9 C=0;6($("#H").r>0){6($("#H").1a(\'U\')){C=7.g($("#H").e(\'2t\'));6($("#x").r>0){9 2r=7.g($("#x").e(\'2o\'));6(t-C>=0){9 1i=t-C;6(1i>2r){1i=2r}$("#1x").5(7.o(1i,2))}}}j{6($("#x").r>0){9 1i=7.g($("#x").e(\'2o\'));$("#1x").5(7.o(1i,2))}}}9 2p=0;6($("#x").r>0){6($("#x").1a(\'U\')){2p=7.g($("#1x").5())}}t=t-C-2p;6(t<=0){t=0}$(\'.t\').5(7.o(t));3.2s();p t};3.Y=d(){9 G=7.g($(\'.G\').5());$(\'#2L\').h();$(\'#2k\').5(\'\');$(\'#2K\').5(\'0\');9 C=0;9 F=7.g($(".F").f());9 E=7.g($(".E").f());9 m=7.g($(".m").f());9 n=7.g($(".n").f());6(3.4.s==0&&3.4.A==0){6(F>0){$(".3c").5($(".F").f());$(\'.2S\').c()}j{$(\'.2S\').h()}6(E>0){$(".2A").5($(".E").f());$(\'.2x\').c()}j{$(\'.2x\').h()}6(m>0){$(".1s").5($(".m").f());$(\'.14\').c()}j{$(\'.14\').h()}6(n>0){$(".1v").5($(".n").f());$(\'.17\').c()}j{$(\'.17\').h()}p 3.2i(0)}7.1B(\'1D/2m/4q\',{v:3.4.2q,G:G,s:3.4.s,B:3.4.B,A:3.4.A,M:3.4.M,L:3.4.L,m:m,n:n},d(b){6(b.1o==1){$(\'#2k\').5(b.8.2k);C=b.8.C;9 2n=b.8.m;9 2l=b.8.n;6(2n>0){$(".1s").5(2n);$(\'.14\').c()}j{$(".1s").5(0);$(\'.14\').h()}6(2l>0){$(".1v").5(2l);$(\'.17\').c()}j{$(".1v").5(0);$(\'.17\').h()}6(C>0){$(\'#2L\').c();$(\'#2K\').5(7.o(C,2))}}j{6(m>0){$(".1s").5($(".m").f());$(\'.14\').c()}j{$(\'.14\').h()}6(n>0){$(".1v").5($(".n").f());$(\'.17\').c()}j{$(\'.17\').h()}C=0}p 3.2i(C)},I,I)};3.1A=d(3i,1z){9 $l=$(3i);9 W=1S($("#W").f());6(3.4.3O){u.2B("请先绑定手机","提示",d(){2h.1I=7.1E(\'37/3M\',{3r:3v(2h.1I)})});p}6($l.P(\'23\')){p}6(3.4.33){}j 6(3.4.K||3.4.29||3.4.2g){6(3.4.K&&3.4.2e==0){u.R.c(\'请选择自提点\');p}6($(\':Q[X=1W]\').3j()&&$(\':Q[X=1W]\').P("e-21")==0){u.R.c(\'请填写联系人\');p}6($(\':Q[X=1g]\').3j()&&$(\':Q[X=1g]\').P("e-21")==0){u.R.c(\'请填写联系电话\');p}6(!$(\':Q[X=1g]\').4j()&&$(\':Q[X=1g]\').P("e-21")==0){u.R.c(\'联系电话格式有误\');p}}j{6(3.4.V==0){u.R.c(\'请选择收货地址\');p}j{6(3.1m==1){u.R.c(3.1h);p}}}9 1Z=\'\';6(3.4.44!=\'0\'){9 1Z=1U.45(\'.1U-1V\');6(!1Z){p}}6(3.4.1Y==0){6(3.4.v.r==1){3.4.v[0].1T=1S($(\'.1X\').f())}}$l.P(\'23\',1);9 e={\'1H\':3.4.1H,\'T\':3.4.T,\'v\':3.4.v,\'W\':W,\'2Z\':3.4.2Z,\'20\':3.4.20,\'3u\':1Z,\'3p\':3.4.K?1:0,\'1Y\':3.4.1Y,\'3S\':3.4.K?3.4.2e:0,\'V\':!3.4.K?3.4.V:0,\'3Q\':(3.4.K||3.4.2g||3.4.29)?{\'1W\':$(\':Q[X=1W]\').f(),\'1g\':$(\':Q[X=1g]\').f(),\'1c\':$(\'#y .1c\').5(),\'1R\':$(\'#31\').5(),\'1Q\':$(\'#y .1Q\').5(),\'z\':$(\'#y .z\').5()}:\'\',\'32\':$("#32").f(),\'3b\':$("#3b").f(),\'4i\':($("#H").r>0&&$("#H").1a(\'U\'))?1:0,\'3R\':($("#x").r>0&&$("#x").1a(\'U\'))?1:0,\'B\':3.4.B,\'s\':3.4.s,\'A\':3.4.A,\'M\':3.4.M,\'L\':3.4.L,\'2W\':$(\'#2W\').f(),\'1A\':I,\'1z\':1z,\'2j\':3.4.2j,\'3d\':3.4.3d};u.28.c(\'47\');7.1B(\'1D/2m/1A\',e,d(1k){$l.3C(\'23\',1);6(1k.1o==0){u.28.h();u.R.c(1k.8.2z);p}6(1k.1o==-1){u.28.h();u.2B(1k.8.2z);p}2h.1I=7.1E(\'1D/40\',{T:1k.8.1H})},19,I)};p 3});',62,283,'|||modal|params|html|if|core|result|var||getjson|show|function|data|val|getNumber|hide|find|else|coupondiv|this|discountprice|isdiscountprice|number_format|return|fui|length|couponid|totalprice|FoxUI|goods|cell|deductcredit2|carrierInfo|address|wxid|contype|deductprice|loadAddress|lotterydiscountprice|taskdiscountprice|goodsprice|deductcredit|true|click|iscarry|wxcode|wxcardid|addressInfo|window|attr|input|toast|number|id|checked|addressid|giftid|name|calcCouponPrice|each|value|loadStore|giftPicker|picker|discount|deductenough_money|rjson|isdiscount|merch_deductenough_money|false|prop|label|realname|info|caculate|merchs|carrier_mobile|nodispatch|td|goodsid|ret|buyagain|isnodispatch|display|status|text|css|num|showdiscountprice|dispatchprice|00|showisdiscountprice|couponmerchid|deductcredit2_money|couponprice|token|submit|json|marketprice|order|getUrl|unit|block|orderid|href|coupons|seckillprice|selectedAddressData|undefined|wxcards|badge|typeof|storename|mobile|parseInt|total|diyform|container|carrier_realname|shownum|fromcart|diyformdata|liveid|set|include_dispath|stop|merch_deductenough_enough|enoughprice|merch_enoughprice|deductenough_enough|loader|isverify|item|gift|close|minbuy|storeid|maxbuy|isvirtual|location|totalPrice|packageid|coupondeduct_text|isdiscountpricenew|create|discountpricenew|credit2|deductprice2|coupon_goods|td1|bindCoupon|money|new|FoxUIModal|content|islotterydiscount|maskClick|message|showlotterydiscountprice|alert|coupon|sale|btn|couponloading|biz|extraClass|textarea|has|coupondeduct_money|coupondeduct_div|no|selectedStoreData|tpl|editAddressData|memberInfo|showdispatchprice|istaskdiscount|checkbox|radio|select|invoicename|min|max|gdid|closest|carrierInfo_mobile|remark|isonlyverifygoods|couponcount|dispatchid|merch_deductenough|member|deductenough|buyagainprice|deductmoney|officcode|showtaskdiscountprice|fromquick|couponname|merchid|seckillprice_money|hideCoupon|obj|isEmpty|tab|tab2|carrierTab|tab1|handlers|dispatchtype|numbers|backurl|maxToast|minToast|diydata|btoa|callback|none|areas|replace|ig|icon|removeAttr|extend|define|plugin|init|dingwei|selector|list|media|subtitle|bind|goodscount|mustbind|orderSelectedAddressID|carriers|deduct2|carrierid|credit|open|showbuyagainprice|price|dflag|addClass|store|pay|allshop|parents|option|orderdiyformid|getData|require|mini|onSelected|type|query|packagePicker|unbind|util|gifttitle|title|giftclick|danger|deduct|isMobile|buybtn|deductcredit_money|document|onCancel|deductcredit_info|parse|getcouponprice|cache|success|JSON|querygift|detail|on|ajax|url'.split('|'),0,{}))


define(['core', 'tpl', 'biz/plugin/diyform'],
function(core, tpl, diyform) {
	var modal = {
		params: {
			orderid: 0,
			goods: [],
			coupon_goods: [],
			merchs: [],
			iscarry: 0,
			isverify: 0,
			isvirtual: 0,
			isonlyverifygoods: 0,
			addressid: 0,
			contype: 0,
			couponid: 0,
			wxid: 0,
			wxcardid: 0,
			wxcode: "",
			isnodispatch: 0,
			nodispatch: '',
			packageid: 0
		}
	};
	modal.init = function(params) {
		modal.params = $.extend(modal.params, params || {});
		modal.params.couponid = 0;
		$('#coupondiv').find('.fui-cell-label').html('优惠券');
		$('#coupondiv').find('.fui-cell-info').html('');
		var discountprice = core.getNumber($(".discountprice").val());
		var isdiscountprice = core.getNumber($(".isdiscountprice").val());
		if (discountprice > 0) {
			$('.discount').show()
		}
		if (isdiscountprice > 0) {
			$('.isdiscount').show()
		}
		var loadAddress = false;
		if (typeof(window.selectedAddressData) !== 'undefined') {
			loadAddress = window.selectedAddressData
		} else if (typeof(window.editAddressData) !== 'undefined') {
			loadAddress = window.editAddressData;
			loadAddress.address = loadAddress.areas.replace(/ /ig, '') + ' ' + loadAddress.address
		}
		if (loadAddress) {
			modal.params.addressid = loadAddress.id;
			$('#addressInfo .has-address').show();
			$('#addressInfo .no-address').hide();
			$('#addressInfo .icon-dingwei').show();
			$('#addressInfo .realname').html(loadAddress.realname);
			$('#addressInfo .mobile').html(loadAddress.mobile);
			$('#addressInfo .address').html(loadAddress.address);
			$('#addressInfo a').attr('href', core.getUrl('member/address/selector'));
			$('#addressInfo a').click(function() {
				window.orderSelectedAddressID = loadAddress.id
			})
		}
		var loadStore = false;
		if (typeof(window.selectedStoreData) !== 'undefined') {
			loadStore = window.selectedStoreData;
			modal.params.storeid = loadStore.id;
			$('#carrierInfo .storename').html(loadStore.storename);
			$('#carrierInfo .realname').html(loadStore.realname);
			$('#carrierInfo_mobile').html(loadStore.mobile);
			$('#carrierInfo .address').html(loadStore.address);
			$('#carrierInfo').find('.no-address').css("display", "none");
			$('#carrierInfo').find('.has-address').css("display", "block");
			$('#carrierInfo').find('.fui-list-media').css("display", "block");
			$('#carrierInfo').find('.text').css("display", "block");
			$('#carrierInfo').find('.subtitle').css("display", "block")
		}
		FoxUI.tab({
			container: $('#carrierTab'),
			handlers: {
				tab1: function() {
					modal.params.iscarry = 0;
					$('#addressInfo').show(),
					$('#carrierInfo').hide(),
					$('#memberInfo').hide(),
					$('#showdispatchprice').show();
					modal.caculate()
				},
				tab2: function() {
					modal.params.iscarry = 1;
					$('#addressInfo').hide(),
					$('#carrierInfo').show(),
					$('#memberInfo').show(),
					$('#showdispatchprice').hide();
					modal.caculate()
				}
			}
		});
		var number = $('.fui-number');
		if (number.length > 0) {
			var maxbuy = number.data('maxbuy') || 0,
			goodsid = number.data('goodsid'),
			minbuy = number.data('minbuy') || 0,
			unit = number.data('unit') || '件';
			number.numbers({
				max: maxbuy,
				min: minbuy,
				minToast: "{min}" + unit + "起售",
				maxToast: "最多购买{max}" + unit,
				callback: function(num) {
					$.each(modal.params.goods,
					function() {
						if (this.goodsid == goodsid) {
							this.total = num;
							return false
						}
					});
					$.each(modal.params.coupon_goods,
					function() {
						if (this.goodsid == goodsid) {
							this.total = num;
							return false
						}
					});
					modal.params.contype = 0;
					modal.params.couponid = 0;
					modal.params.wxid = 0;
					modal.params.wxcardid = "";
					modal.params.wxcode = "";
					modal.params.couponmerchid = 0;
					$('#coupondiv').find('.fui-cell-label').html('优惠券');
					$('#coupondiv').find('.fui-cell-info').html('');
					$('#goodscount').html(num);
					var marketprice = core.getNumber(number.closest('.goods-item').find('.marketprice').html()) * num;
					$('.goodsprice').html(core.number_format(marketprice, 2));
					modal.caculate()
				}
			})
		}
		$('#deductcredit').click(function() {
			modal.calcCouponPrice()
		});
		$('#deductcredit2').click(function() {
			modal.calcCouponPrice()
		});
		modal.bindCoupon();
		$(document).click(function() {
			$('input,select,textarea').each(function() {
				$(this).attr('data-value', $(this).val())
			});
			$(':checkbox,:radio').each(function() {
				$(this).attr('data-checked', $(this).prop('checked'))
			})
		});
		$('input,select,textarea').each(function() {
			var value = $(this).attr('data-value') || '';
			if (value != '') {
				$(this).val(value)
			}
		});
		$(':checkbox,:radio').each(function() {
			var value = $(this).attr('data-checked') === 'true' ? true: false;
			$(this).prop('checked', value)
		});
		$('.buybtn').click(function() {
			modal.submit(this, params.token)
		});
		modal.caculate();
		$(".fui-cell-giftclick").click(function() {
			modal.giftPicker = new FoxUIModal({
				content: $('#gift-picker-modal').html(),
				extraClass: 'picker-modal',
				maskClick: function() {
					modal.giftPicker.close()
				}
			});
			modal.giftPicker.container.find('.btn-danger').click(function() {
				modal.giftPicker.close()
			});
			modal.giftPicker.show();
			var giftid = $("#giftid").val();
			$(".gift-item").each(function() {
				if ($(this).val() == giftid) {
					$(this).prop("checked", "true")
				}
			});
			$(".gift-item").on("click",
			function() {
				$.ajax({
					url: core.getUrl('goods/detail/querygift', {
						id: $(this).val()
					}),
					cache: true,
					success: function(data) {
						data = window.JSON.parse(data);
						if (data.status > 0) {
							$("#giftid").val(data.result.id);
							$("#gifttitle").text(data.result.title)
						}
					}
				})
			})
		});
		$('.show-allshop-btn').click(function() {
			$(this).closest('.store-container').addClass('open')
		})
	};
	modal.giftPicker = function() {
		modal.giftPicker = new FoxUIModal({
			content: $('#option-picker-modal').html(),
			extraClass: 'picker-modal',
			maskClick: function() {
				modal.packagePicker.close()
			}
		})
	};
	modal.bindCoupon = function() {
		$('#coupondiv').unbind('click').click(function() {
			$('#couponloading').show();
			core.json('sale/coupon/util/query', {
				money: 0,
				type: 0,
				merchs: modal.params.merchs,
				goods: modal.params.goods
			},
			function(rjson) {
				$('#couponloading').hide();
				if (rjson.result.coupons.length > 0 || rjson.result.wxcards.length > 0) {
					$('#coupondiv').show().find('.badge').html(rjson.result.coupons.length + rjson.result.wxcards.length).show();
					$('#coupondiv').find('.text').hide();
					require(['biz/sale/coupon/picker'],
					function(picker) {
						picker.show({
							couponid: modal.params.couponid,
							coupons: rjson.result.coupons,
							wxcards: rjson.result.wxcards,
							onCancel: function() {
								modal.params.contype = 0;
								modal.params.couponid = 0;
								modal.params.wxid = 0;
								modal.params.wxcardid = "";
								modal.params.wxcode = "";
								modal.params.couponmerchid = 0;
								$('#coupondiv').find('.fui-cell-label').html('优惠券');
								$('#coupondiv').find('.fui-cell-info').html('');
								modal.calcCouponPrice()
							},
							onSelected: function(data) {
								modal.params.contype = data.contype;
								if (modal.params.contype == 1) {
									modal.params.couponid = 0;
									modal.params.wxid = data.wxid;
									modal.params.wxcardid = data.wxcardid;
									modal.params.wxcode = data.wxcode;
									modal.params.couponmerchid = data.merchid;
									$('#coupondiv').find('.fui-cell-label').html('已选择');
									$('#coupondiv').find('.fui-cell-info').html(data.couponname);
									$('#coupondiv').data(data);
									modal.calcCouponPrice()
								} else if (modal.params.contype == 2) {
									modal.params.couponid = data.couponid;
									modal.params.wxid = 0;
									modal.params.wxcardid = "";
									modal.params.wxcode = "";
									modal.params.couponmerchid = data.merchid;
									$('#coupondiv').find('.fui-cell-label').html('已选择');
									$('#coupondiv').find('.fui-cell-info').html(data.couponname);
									$('#coupondiv').data(data);
									modal.calcCouponPrice()
								} else {
									modal.params.contype = 0;
									modal.params.couponid = 0;
									modal.params.wxid = 0;
									modal.params.wxcardid = "";
									modal.params.wxcode = "";
									modal.params.couponmerchid = 0;
									$('#coupondiv').find('.fui-cell-label').html('优惠券');
									$('#coupondiv').find('.fui-cell-info').html('');
									modal.calcCouponPrice()
								}
							}
						})
					})
				} else {
					FoxUI.toast.show('未找到优惠券!');
					modal.hideCoupon()
				}
			},
			false, true)
		})
	};
	modal.hideCoupon = function() {
		$('#coupondiv').hide();
		$('#coupondiv').find('.badge').html('0').hide();
		$('#coupondiv').find('.text').show()
	};
	modal.caculate = function() {
		var goodsprice = core.getNumber($('.goodsprice').html());
		var taskdiscountprice = core.getNumber($(".taskdiscountprice").val());
		var lotterydiscountprice = core.getNumber($(".lotterydiscountprice").val());
		var discountprice = core.getNumber($(".discountprice").val());
		var isdiscountprice = core.getNumber($(".isdiscountprice").val());
		var totalprice = goodsprice - taskdiscountprice - lotterydiscountprice - discountprice - isdiscountprice;
		if ($('.shownum').length > 0) {
			totalprice = core.getNumber($('.marketprice').html()) * parseInt($('.shownum').val())
		}
		if (modal.params.fromcart == 0) {
			if (modal.params.goods.length == 1) {
				modal.params.goods[0].total = parseInt($('.shownum').val())
			}
		}
		if (typeof(window.selectedAddressData) !== 'undefined') {
			modal.params.addressid = window.selectedAddressData.id
		}
		core.json('order/create/caculate', {
			totalprice: totalprice,
			addressid: modal.params.addressid,
			dispatchid: modal.params.dispatchid,
			dflag: modal.params.iscarry,
			goods: modal.params.goods,
			liveid: modal.params.liveid
		},
		function(getjson) {
			if (getjson.status == 1) {
				if (modal.params.iscarry) {
					$('.dispatchprice').html('0.00')
				} else {
					$('.dispatchprice').html(core.number_format(getjson.result.price, 2))
				}
				if (getjson.result.taskdiscountprice) {
					$('#taskdiscountprice').val(core.number_format(getjson.result.taskdiscountprice, 2))
				}
				if (getjson.result.lotterydiscountprice) {
					$('#lotterydiscountprice').val(core.number_format(getjson.result.lotterydiscountprice, 2))
				}
				if (getjson.result.discountprice) {
					$('#discountprice').val(core.number_format(getjson.result.discountprice, 2))
				}
				if (getjson.result.buyagain) {
					$('#buyagain').val(core.number_format(getjson.result.buyagain, 2));
					$('#showbuyagainprice').html(core.number_format(getjson.result.buyagain, 2)).parents(".fui-cell").show()
				}
				if (getjson.result.isdiscountprice) {
					$('#isdiscountprice').val(core.number_format(getjson.result.isdiscountprice, 2))
				}
				if (getjson.result.deductcredit) {
					$('#deductcredit_money').html(core.number_format(getjson.result.deductmoney, 2));
					$('#deductcredit_info').html(getjson.result.deductcredit);
					$("#deductcredit").data('credit', getjson.result.deductcredit);
					$("#deductcredit").data('money', core.number_format(getjson.result.deductmoney, 2))
				}
				if (getjson.result.deductcredit2) {
					$('#deductcredit2_money').html(getjson.result.deductcredit2);
					$("#deductcredit2").data('credit2', getjson.result.deductcredit2)
				}
				if (getjson.result.include_dispath > 0) {
					$('#include_dispath').show()
				} else {
					$('#include_dispath').hide()
				}
				if (getjson.result.seckillprice > 0) {
					$('#seckillprice').show();
					$('#seckillprice_money').html(core.number_format(getjson.result.seckillprice, 2))
				} else {
					$('#seckillprice').hide();
					$('#seckillprice_money').html(0)
				}
				if (getjson.result.couponcount > 0) {
					$('#coupondiv').show().find('.badge').html(getjson.result.couponcount).show();
					$('#coupondiv').find('.text').hide()
				} else {
					modal.params.couponid = 0;
					$('#coupondiv').hide().find('.badge').html(0).hide()
				}
				if (getjson.result.merch_deductenough_money > 0) {
					$('#merch_deductenough').show();
					$('#merch_deductenough_money').html(core.number_format(getjson.result.merch_deductenough_money, 2));
					$('#merch_deductenough_enough').html(core.number_format(getjson.result.merch_deductenough_enough, 2))
				} else {
					$('#merch_deductenough').hide();
					$('#merch_deductenough_money').html('0.00');
					$('#merch_deductenough_enough').html('0.00')
				}
				if (getjson.result.deductenough_money > 0) {
					$('#deductenough').show();
					$('#deductenough_money').html(core.number_format(getjson.result.deductenough_money, 2));
					$('#deductenough_enough').html(core.number_format(getjson.result.deductenough_enough, 2))
				} else {
					$('#deductenough').hide();
					$('#deductenough_money').html('0.00');
					$('#deductenough_enough').html('0.00')
				}
				if (getjson.result.merchs) {
					modal.params.merchs = getjson.result.merchs
				}
				if (getjson.result.isnodispatch == 1) {
					modal.isnodispatch = 1;
					modal.nodispatch = getjson.result.nodispatch;
					FoxUI.toast.show(modal.nodispatch)
				} else {
					modal.isnodispatch = 0;
					modal.nodispatch = ''
				}
				modal.calcCouponPrice()
			}
		},
		true, true)
	};
	modal.totalPrice = function(couponprice) {
		var goodsprice = core.getNumber($('.goodsprice').html());
		var couponprice = couponprice;
		var taskdiscountprice = core.getNumber($(".showtaskdiscountprice").html());
		var lotterydiscountprice = core.getNumber($(".showlotterydiscountprice").html());
		var discountprice = core.getNumber($(".showdiscountprice").html());
		var isdiscountprice = core.getNumber($(".showisdiscountprice").html());
		var buyagainprice = core.getNumber($("#buyagain").val());
		var totalprice = goodsprice - taskdiscountprice - lotterydiscountprice - discountprice - isdiscountprice - couponprice - buyagainprice;
		var dispatchprice = core.getNumber($(".dispatchprice").html());
		var merch_enoughprice = 0;
		if ($("#merch_deductenough_money").length > 0 && $("#merch_deductenough_money").html() != '') {
			merch_enoughprice = core.getNumber($("#merch_deductenough_money").html())
		}
		var enoughprice = 0;
		if ($("#deductenough_money").length > 0 && $("#deductenough_money").html() != '') {
			enoughprice = core.getNumber($("#deductenough_money").html())
		}
		totalprice = totalprice - merch_enoughprice - enoughprice + dispatchprice;
		var deductprice = 0;
		if ($("#deductcredit").length > 0) {
			if ($("#deductcredit").prop('checked')) {
				deductprice = core.getNumber($("#deductcredit").data('money'));
				if ($("#deductcredit2").length > 0) {
					var td1 = core.getNumber($("#deductcredit2").data('credit2'));
					if (totalprice - deductprice >= 0) {
						var td = totalprice - deductprice;
						if (td > td1) {
							td = td1
						}
						$("#deductcredit2_money").html(core.number_format(td, 2))
					}
				}
			} else {
				if ($("#deductcredit2").length > 0) {
					var td = core.getNumber($("#deductcredit2").data('credit2'));
					$("#deductcredit2_money").html(core.number_format(td, 2))
				}
			}
		}
		var deductprice2 = 0;
		if ($("#deductcredit2").length > 0) {
			if ($("#deductcredit2").prop('checked')) {
				deductprice2 = core.getNumber($("#deductcredit2_money").html())
			}
		}
		totalprice = totalprice - deductprice - deductprice2;
		if (totalprice <= 0) {
			totalprice = 0
		}
		$('.totalprice').html(core.number_format(totalprice));
		modal.bindCoupon();
		return totalprice
	};
	modal.calcCouponPrice = function() {
		var goodsprice = core.getNumber($('.goodsprice').html());
		$('#coupondeduct_div').hide();
		$('#coupondeduct_text').html('');
		$('#coupondeduct_money').html('0');
		var deductprice = 0;
		var taskdiscountprice = core.getNumber($(".taskdiscountprice").val());
		var lotterydiscountprice = core.getNumber($(".lotterydiscountprice").val());
		var discountprice = core.getNumber($(".discountprice").val());
		var isdiscountprice = core.getNumber($(".isdiscountprice").val());
		if (modal.params.couponid == 0 && modal.params.wxid == 0) {
			if (taskdiscountprice > 0) {
				$(".showtaskdiscountprice").html($(".taskdiscountprice").val());
				$('.istaskdiscount').show()
			} else {
				$('.istaskdiscount').hide()
			}
			if (lotterydiscountprice > 0) {
				$(".showlotterydiscountprice").html($(".lotterydiscountprice").val());
				$('.islotterydiscount').show()
			} else {
				$('.islotterydiscount').hide()
			}
			if (discountprice > 0) {
				$(".showdiscountprice").html($(".discountprice").val());
				$('.discount').show()
			} else {
				$('.discount').hide()
			}
			if (isdiscountprice > 0) {
				$(".showisdiscountprice").html($(".isdiscountprice").val());
				$('.isdiscount').show()
			} else {
				$('.isdiscount').hide()
			}
			return modal.totalPrice(0)
		}
		core.json('order/create/getcouponprice', {
			goods: modal.params.coupon_goods,
			goodsprice: goodsprice,
			couponid: modal.params.couponid,
			contype: modal.params.contype,
			wxid: modal.params.wxid,
			wxcardid: modal.params.wxcardid,
			wxcode: modal.params.wxcode,
			discountprice: discountprice,
			isdiscountprice: isdiscountprice
		},
		function(getjson) {
			if (getjson.status == 1) {
				$('#coupondeduct_text').html(getjson.result.coupondeduct_text);
				deductprice = getjson.result.deductprice;
				var discountpricenew = getjson.result.discountprice;
				var isdiscountpricenew = getjson.result.isdiscountprice;
				if (discountpricenew > 0) {
					$(".showdiscountprice").html(discountpricenew);
					$('.discount').show()
				} else {
					$(".showdiscountprice").html(0);
					$('.discount').hide()
				}
				if (isdiscountpricenew > 0) {
					$(".showisdiscountprice").html(isdiscountpricenew);
					$('.isdiscount').show()
				} else {
					$(".showisdiscountprice").html(0);
					$('.isdiscount').hide()
				}
				if (deductprice > 0) {
					$('#coupondeduct_div').show();
					$('#coupondeduct_money').html(core.number_format(deductprice, 2))
				}
			} else {
				if (discountprice > 0) {
					$(".showdiscountprice").html($(".discountprice").val());
					$('.discount').show()
				} else {
					$('.discount').hide()
				}
				if (isdiscountprice > 0) {
					$(".showisdiscountprice").html($(".isdiscountprice").val());
					$('.isdiscount').show()
				} else {
					$('.isdiscount').hide()
				}
				deductprice = 0
			}
			return modal.totalPrice(deductprice)
		},
		true, true)
	};
	modal.submit = function(obj, token) {
		var $this = $(obj);
		var giftid = parseInt($("#giftid").val());
		if (modal.params.mustbind) {
			FoxUI.alert("请先绑定手机", "提示",
			function() {
				location.href = core.getUrl('member/bind', {
					backurl: btoa(location.href)
				})
			});
			return
		}
		if ($this.attr('stop')) {
			return
		}
		if (modal.params.isonlyverifygoods) {} else if (modal.params.iscarry || modal.params.isverify || modal.params.isvirtual) {
			if (modal.params.iscarry && modal.params.storeid == 0) {
				FoxUI.toast.show('请选择自提点');
				return
			}
			if ($(':input[name=carrier_realname]').isEmpty() && $(':input[name=carrier_realname]').attr("data-set") == 0) {
				FoxUI.toast.show('请填写联系人');
				return
			}
			if ($(':input[name=carrier_mobile]').isEmpty() && $(':input[name=carrier_mobile]').attr("data-set") == 0) {
				FoxUI.toast.show('请填写联系电话');
				return
			}
			if (!$(':input[name=carrier_mobile]').isMobile() && $(':input[name=carrier_mobile]').attr("data-set") == 0) {
				FoxUI.toast.show('联系电话格式有误');
				return
			}
		} else {
			if (modal.params.addressid == 0) {
				FoxUI.toast.show('请选择收货地址');
				return
			} else {
				if (modal.isnodispatch == 1) {
					FoxUI.toast.show(modal.nodispatch);
					return
				}
			}
		}
		var diyformdata = '';
		if (modal.params.orderdiyformid != '0') {
			var diyformdata = diyform.getData('.diyform-container');
			if (!diyformdata) {
				return
			}
		}
		if (modal.params.fromcart == 0) {
			if (modal.params.goods.length == 1) {
				modal.params.goods[0].total = parseInt($('.shownum').val())
			}
		}
		$this.attr('stop', 1);
		var data = {
			'orderid': modal.params.orderid,
			'id': modal.params.id,
			'goods': modal.params.goods,
			'giftid': giftid,
			'gdid': modal.params.gdid,
			'liveid': modal.params.liveid,
			'diydata': diyformdata,
			'dispatchtype': modal.params.iscarry ? 1 : 0,
			'fromcart': modal.params.fromcart,
			'carrierid': modal.params.iscarry ? modal.params.storeid: 0,
			'addressid': !modal.params.iscarry ? modal.params.addressid: 0,
			'carriers': (modal.params.iscarry || modal.params.isvirtual || modal.params.isverify) ? {
				'carrier_realname': $(':input[name=carrier_realname]').val(),
				'carrier_mobile': $(':input[name=carrier_mobile]').val(),
				'realname': $('#carrierInfo .realname').html(),
				'mobile': $('#carrierInfo_mobile').html(),
				'storename': $('#carrierInfo .storename').html(),
				'address': $('#carrierInfo .address').html()
			}: '',
			'remark': $("#remark").val(),
			'officcode': $("#officcode").val(),
			'deduct': ($("#deductcredit").length > 0 && $("#deductcredit").prop('checked')) ? 1 : 0,
			'deduct2': ($("#deductcredit2").length > 0 && $("#deductcredit2").prop('checked')) ? 1 : 0,
			'contype': modal.params.contype,
			'couponid': modal.params.couponid,
			'wxid': modal.params.wxid,
			'wxcardid': modal.params.wxcardid,
			'wxcode': modal.params.wxcode,
			'invoicename': $('#invoicename').val(),
			'submit': true,
			'token': token,
			'packageid': modal.params.packageid,
			'fromquick': modal.params.fromquick
		};
		FoxUI.loader.show('mini');
		core.json('order/create/submit', data,
		function(ret) {
			$this.removeAttr('stop', 1);
			if (ret.status == 0) {
				FoxUI.loader.hide();
				FoxUI.toast.show(ret.result.message);
				return
			}
			if (ret.status == -1) {
				FoxUI.loader.hide();
				FoxUI.alert(ret.result.message);
				return
			}
			location.href = core.getUrl('order/pay', {
				id: ret.result.orderid
			})
		},
		false, true)
	};
	return modal
});